<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Cardtable</title>
    <link rel="stylesheet" href="css/base.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
  </head>
  <body>
    <div id="content"></div>
    <script type="text/babel">

// Table - (this contains all table spaces)
var Table = React.createClass({
  getInitialState: function(){
    var socket = io.connect();
    socket.emit('initTable', this.props.id);
    return {
      id: this.props.id,
      socket: socket,
      // dimensions (TODO get from window)
      height: 600,
      width: 600,
      // will be filled in after render
      tablespaces: []
    };
  },
  updateTableState: function(data){
    console.log('update table state');
    console.log(data);
    var tablespacesWithData = data;
    // define dimensions
    // TODO noooott ssuuurrreee.......
    // this will eventually scale but we'll figure it out then, for now just defined statically here
    // size = element size + border
    var tablespaceDimensions = {x: 50, xBorder: 2, y: 70, yBorder: 2};

    // create a number of tablespaces based on dimensions of table
    // TODO account for border other than just +2
    var tablespacesX = Math.floor(this.state.width / (tablespaceDimensions.x + tablespaceDimensions.xBorder));
    var tablespacesY = Math.floor(this.state.height / (tablespaceDimensions.y + tablespaceDimensions.yBorder));
    var tablespaces = [];
    var x, y;
    for(y = 1; y <= tablespacesY; y++){
      for(x = 1; x <= tablespacesX; x++){
        var tablespaceId = y + ":" + x;
        var cards = (tablespacesWithData[tablespaceId])
          ? tablespacesWithData[tablespaceId]['cards'].map(function(card){ return ( <Card id={card.id} key={card.id} socket={this.state.socket} color={card.color} /> )}.bind(this))
          : [];
        tablespaces.push(<Tablespace id={tablespaceId} key={tablespaceId} socket={this.state.socket} cards={cards} width={tablespaceDimensions.x} height={tablespaceDimensions.y} />);
      }
    }
    this.setState({tablespaces: tablespaces});
  },
  componentDidMount: function(){
    // setup websocket listener for updates
    this.state.socket.on('updateTable', this.updateTableState);
  },
  dimensionsStyle: function(){
    return { width: this.state.width + 'px', height: this.state.height + 'px' };
  },
  render: function(){
    return (
      <div className="table" style={this.dimensionsStyle()} >
        {this.state.tablespaces}
      </div>
    );
  }
});

// TableSpace -  this is a space on a table where cards can be placed
var Tablespace = React.createClass({
  getInitialState: function(){
    return {
      id: this.props.id,
      height: this.props.height,
      width: this.props.width,
      cards: this.props.cards,
      tableSocket: this.props.socket
    };
  },
  dimensionsStyle: function(){
    return { height: this.state.height + 'px', width: this.state.width + 'px'};
  },
  dragOver: function(event){
    event.preventDefault();
  },
  drop: function(event){
    event.preventDefault();
    var cardId = event.dataTransfer.getData("card");
    this.state.tableSocket.emit('moveCardPosition', {cardId: cardId, newTablespaceId: this.state.id});
  },
  render: function(){
    return (
      <div className="tablespace" style={this.dimensionsStyle()} onDragOver={this.dragOver} onDrop={this.drop}>
        {this.state.cards}
      </div>
    )
  }
});

// Card - this is a card
var Card = React.createClass({
  getInitialState: function(){
    return {
      id: this.props.id,
      color: this.props.color,
      tableSocket: this.props.socket
    };
  },
  dragStart: function(event){
    event.dataTransfer.setData('card', this.state.id)
  },
  cardStyle: function(){
    return { backgroundColor: this.state.color }
  },
  render: function(){
    return (
      <div key={this.state.id} draggable="true" className="card" style={this.cardStyle()} onDragStart={this.dragStart} />
    )
  }
});


ReactDOM.render(
 <Table id="1" />,
 document.getElementById('content')
);

    </script>
  </body>
</html>
